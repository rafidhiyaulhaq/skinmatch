const baseUrl = 'https://skinmatch.up.railway.app';
let currentEndpoint = '';
let currentToken = '';

function tryEndpoint(endpoint) {
    currentEndpoint = endpoint;
    const modal = document.getElementById('endpointModal');
    const modalContent = document.getElementById('modalContent');
    const modalTitle = document.getElementById('modalTitle');
    
    modal.classList.remove('hidden');
    
    let content = '';
    switch(endpoint) {
        case 'register':
            modalTitle.textContent = 'Register New User';
            content = `
                <div class="mb-4">
                    <label class="block mb-2">Username:</label>
                    <input type="text" id="username" class="w-full border p-2 rounded">
                </div>
                <div class="mb-4">
                    <label class="block mb-2">Email:</label>
                    <input type="email" id="email" class="w-full border p-2 rounded">
                </div>
                <div class="mb-4">
                    <label class="block mb-2">Password:</label>
                    <input type="password" id="password" class="w-full border p-2 rounded">
                </div>
            `;
            break;

        case 'login':
            modalTitle.textContent = 'Login';
            content = `
                <div class="mb-4">
                    <label class="block mb-2">Email:</label>
                    <input type="email" id="email" class="w-full border p-2 rounded">
                </div>
                <div class="mb-4">
                    <label class="block mb-2">Password:</label>
                    <input type="password" id="password" class="w-full border p-2 rounded">
                </div>
            `;
            break;

        case 'profile':
            modalTitle.textContent = 'Get Profile';
            content = `
                <div class="mb-4">
                    <label class="block mb-2">Bearer Token:</label>
                    <input type="text" id="token" class="w-full border p-2 rounded" value="${currentToken}">
                </div>
            `;
            break;

        case 'submitQuiz':
            modalTitle.textContent = 'Submit Quiz';
            content = `
                <div class="mb-4">
                    <label class="block mb-2">Bearer Token:</label>
                    <input type="text" id="token" class="w-full border p-2 rounded" value="${currentToken}">
                </div>
                <div class="mb-4">
                    <label class="block mb-2">Answers:</label>
                    <textarea id="answers" class="w-full border p-2 rounded" rows="6">{
  "answers": {
    "oiliness": "very_oily",
    "dryness": "not_dry",
    "sensitivity": "not_sensitive",
    "pores": "large_visible",
    "acne": "frequent"
  }
}</textarea>
                </div>
            `;
            break;

        case 'quizHistory':
            modalTitle.textContent = 'Get Quiz History';
            content = `
                <div class="mb-4">
                    <label class="block mb-2">Bearer Token:</label>
                    <input type="text" id="token" class="w-full border p-2 rounded" value="${currentToken}">
                </div>
            `;
            break;

        case 'recommendations':
            modalTitle.textContent = 'Get Recommendations';
            content = `
                <div class="mb-4">
                    <label class="block mb-2">Bearer Token:</label>
                    <input type="text" id="token" class="w-full border p-2 rounded" value="${currentToken}">
                </div>
                <div class="mb-4">
                    <label class="block mb-2">Skin Type:</label>
                    <select id="skinType" class="w-full border p-2 rounded">
                        <option value="oily">Oily</option>
                        <option value="dry">Dry</option>
                        <option value="combination">Combination</option>
                        <option value="normal">Normal</option>
                        <option value="sensitive">Sensitive</option>
                    </select>
                </div>
            `;
            break;

        case 'products':
            modalTitle.textContent = 'Get All Products';
            content = `
                <div class="mb-4">
                    <label class="block mb-2">Category (optional):</label>
                    <select id="category" class="w-full border p-2 rounded">
                        <option value="">All</option>
                        <option value="cleanser">Cleanser</option>
                        <option value="toner">Toner</option>
                        <option value="moisturizer">Moisturizer</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block mb-2">Brand (optional):</label>
                    <input type="text" id="brand" class="w-full border p-2 rounded">
                </div>
                <div class="mb-4">
                    <label class="block mb-2">Min Price (optional):</label>
                    <input type="number" id="minPrice" class="w-full border p-2 rounded">
                </div>
                <div class="mb-4">
                    <label class="block mb-2">Max Price (optional):</label>
                    <input type="number" id="maxPrice" class="w-full border p-2 rounded">
                </div>
            `;
            break;
    }
    
    modalContent.innerHTML = content + `
        <div id="response" class="mt-4 hidden">
            <label class="block mb-2 font-bold">Response:</label>
            <pre class="bg-gray-100 p-4 rounded overflow-auto max-h-60"></pre>
        </div>
    `;
}

function closeModal() {
    document.getElementById('endpointModal').classList.add('hidden');
}

async function sendRequest() {
    const responseDiv = document.getElementById('response');
    const responsePre = responseDiv.querySelector('pre');
    responseDiv.classList.remove('hidden');

    try {
        let url = `${baseUrl}/api-test`;
        let options = {
            headers: {
                'Content-Type': 'application/json'
            }
        };

        switch(currentEndpoint) {
            case 'register':
                url += '/register';
                options.method = 'POST';
                options.body = JSON.stringify({
                    username: document.getElementById('username').value,
                    email: document.getElementById('email').value,
                    password: document.getElementById('password').value
                });
                break;

            case 'login':
                url += '/login';
                options.method = 'POST';
                options.body = JSON.stringify({
                    email: document.getElementById('email').value,
                    password: document.getElementById('password').value
                });
                break;

            case 'profile':
                url += '/profile';
                options.method = 'GET';
                options.headers.Authorization = document.getElementById('token').value;
                break;

            case 'submitQuiz':
                url += '/quiz';
                options.method = 'POST';
                options.headers.Authorization = document.getElementById('token').value;
                options.body = document.getElementById('answers').value;
                break;

            case 'recommendations':
                url += '/products/recommendations';
                options.method = 'GET';
                options.headers.Authorization = document.getElementById('token').value;
                const skinType = document.getElementById('skinType').value;
                url += `?skinType=${skinType}`;
                break;

            case 'products':
                url += '/products';
                options.method = 'GET';
                const params = new URLSearchParams();
                const category = document.getElementById('category').value;
                const brand = document.getElementById('brand').value;
                const minPrice = document.getElementById('minPrice').value;
                const maxPrice = document.getElementById('maxPrice').value;

                if (category) params.append('category', category);
                if (brand) params.append('brand', brand);
                if (minPrice) params.append('minPrice', minPrice);
                if (maxPrice) params.append('maxPrice', maxPrice);

                if (params.toString()) {
                    url += '?' + params.toString();
                }
                break;
        }

        const response = await fetch(url, options);
        const data = await response.json();
        
        if (data.token) {
            currentToken = `Bearer ${data.token}`;
        }
        
        responsePre.textContent = JSON.stringify(data, null, 2);
    } catch (error) {
        responsePre.textContent = JSON.stringify({ error: error.message }, null, 2);
    }
}